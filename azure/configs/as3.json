{
	"$schema": "https://raw.githubusercontent.com/F5Networks/f5-appsvcs-extension/master/schema/latest/as3-schema.json",
	"class": "AS3",
	"action": "deploy",
	"persist": true,
	"declaration": {
		"class": "ADC",
		"schemaVersion": "3.13.0",
		"id": "123abc",
		"label": "Sample 1",
		"remark": "An HTTPS sample application",
		"controls": {
			"trace": true
		},
		"DemoTenant": {
			"class": "Tenant",
			"Shared": {
				"class": "Application",
				"template": "shared"
			},
			"${app_name}": {
				"class": "Application",
				"template": "https",
				"serviceMain": {
					"class": "Service_HTTPS",
					"virtualPort": 443,
					"virtualAddresses": [
						"0.0.0.0"
					],
					"pool": "${web_pool}",
					"policyWAF": {
						"use": "My_ASM_Policy"
					},
					"serverTLS": "webtls",
					"profileTrafficLog": {
						"use": "telemetry_traffic_log_profile"
					},
					"profileAnalyticsTcp": {
						"use": "telemetry_tcp_analytics_profile"
					},
					"securityLogProfiles": [
						{
							"use": "telemetry_asm_security_log_profile"
						}						
					],
					"profileBotDefense": {
						"bigip": "/Common/bot-defense"
					},
					"profileDOS": {
						"bigip": "/Common/dos"
					}
				},
				"My_ASM_Policy": {
					"class": "WAF_Policy",
					"url": "https://raw.githubusercontent.com/f5devcentral/adc-telemetry-based-autoscaling/main/azure/configs/app_sec_policy.xml",
					"ignoreChanges": true
				},
				"${web_pool}": {
					"class": "Pool",
					"monitors": [
						"tcp"
					],
					"members": [{
						"servicePort": 80,
						"addressDiscovery": "consul",
						"updateInterval": 10,
						"uri": "http://${consul_ip}:8500/v1/catalog/service/nginx"
					}]
				},
				"telemetry_local_rule": {
					"remark": "Only required when TS is a local listener",
					"class": "iRule",
					"iRule": "when CLIENT_ACCEPTED {\n  node 127.0.0.1 6514\n}"
				},
				"telemetry_local": {
					"remark": "Only required when TS is a local listener",
					"class": "Service_TCP",
					"virtualAddresses": [
						"255.255.255.254"
					],
					"virtualPort": 6514,
					"iRules": [
						"telemetry_local_rule"
					]
				},
				"telemetry": {
					"class": "Pool",
					"members": [{
						"enable": true,
						"serverAddresses": [
							"255.255.255.254"
						],
						"servicePort": 6514
					}],
					"monitors": [{
						"bigip": "/Common/tcp"
					}]
				},
				"telemetry_hsl": {
					"class": "Log_Destination",
					"type": "remote-high-speed-log",
					"protocol": "tcp",
					"pool": {
						"use": "telemetry"
					}
				},
				"telemetry_formatted": {
					"class": "Log_Destination",
					"type": "splunk",
					"forwardTo": {
						"use": "telemetry_hsl"
					}
				},
				"telemetry_publisher": {
					"class": "Log_Publisher",
					"destinations": [{
						"use": "telemetry_formatted"
					}]
				},
                "telemetry_asm_security_log_profile": {
                    "class": "Security_Log_Profile",
                    "application": {
                        "localStorage": false,
                        "remoteStorage": "splunk",
                        "servers": [{
                            "address": "255.255.255.254",
                            "port": "6514"
                        }],
                        "storageFilter": {
                            "requestType": "all"
                        }
                    }
                },
				"telemetry_traffic_log_profile": {
					"class": "Traffic_Log_Profile",
					"requestSettings": {
						"requestEnabled": true,
						"requestProtocol": "mds-tcp",
						"requestPool": {
							"use": "telemetry"
						},
						"requestTemplate": "event_source=\"request_logging\",hostname=\"$BIGIP_HOSTNAME\",client_ip=\"$CLIENT_IP\",server_ip=\"$SERVER_IP\",http_method=\"$HTTP_METHOD\",http_uri=\"$HTTP_URI\",virtual_name=\"$VIRTUAL_NAME\",event_timestamp=\"$DATE_HTTP\""
					}
				},
				"telemetry_http_analytics_profile": {
					"class": "Analytics_Profile",
					"collectGeo": true,
					"collectMaxTpsAndThroughput": true,
					"collectOsAndBrowser": true,
					"collectIp": true,
					"collectMethod": true,
					"collectPageLoadTime": true,
					"collectResponseCode": true,
					"collectSubnet" : true,
					"collectUrl": true,
					"collectUserAgent": true,
					"collectUserSession": true,
					"publishIruleStatistics": true
				},
				"telemetry_tcp_analytics_profile": {
					"class": "Analytics_TCP_Profile",
					"collectCity": true,
					"collectContinent": true,
					"collectCountry": true,
					"collectNexthop": true,
					"collectPostCode": true,
					"collectRegion": true,
					"collectRemoteHostIp": true,
					"collectRemoteHostSubnet" : true,
					"collectedByServerSide": true
				},
				"webtls": {
					"class": "TLS_Server",
					"certificates": [{
						"certificate": "webcert"
					}]
				},
				"webcert": {
					"class": "Certificate",
					"remark": "in practice we recommend using a passphrase",
					"certificate": "${tls_cert}",
					"privateKey": "{tls_key}"	
				}
			}
		}
	}
}
